<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Python metaclasses &amp; descriptors</title>
<meta name="author" content="(Alex Peitsinis)"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./static/reveal.js/css/reveal.css"/>

<link rel="stylesheet" href="./static/reveal.js/css/theme/beige.css" id="theme"/>

<link rel="stylesheet" href="./static/custom.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-light.min.css"/>
<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = './static/reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide"><h1>Python metaclasses &amp; descriptors</h1>
</section>

<section>
<section id="slide-orgb7112c8">
<h2 id="orgb7112c8">Metaclasses</h2>
<div class="outline-text-2" id="text-orgb7112c8">
</div></section>
<section id="slide-orgca46193">
<h3 id="orgca46193">"type"</h3>
<div class="org-src-container">

<pre><code class="python" >class MyClass(object):
    pass

MyClass            # __main__.MyClass
MyClass.__class__  # type
type(MyClass())    # __main__.MyClass
type(MyClass)      # type
type(object)       # type
type(type)         # type

#      class     parent     class
#      name      classes    __dict__
type( 'Klass',     (),        {}     )  # __main__.Klass
# class Klass(object): pass
</code></pre>
</div>

</section>
<section >

<div class="org-src-container">

<pre><code class="python" ># Klass = type('Klass', (), {})
class Klass(object):
    pass

# Klass2 = type('Klass2', (Klass, ), {})
class Klass2(Klass):
    pass

# Klass3 = type('Klass3', (Klass, Klass2), {'a': 42})
class Klass3(Klass, Klass2):
    a = 42
</code></pre>
</div>

</section>
<section >

<div class="org-src-container">

<pre><code class="python" ># Klass4 = type(
#   'Klass4',
#   (),
#   {
#       'a': 42,
#       'method': lambda instance, num: instance.a + num
#   }
# )
class Klass4(object):
    a = 42
    def method(self, x):
        return self.a + x
</code></pre>
</div>


</section>
<section id="slide-org44854d2">
<h3 id="org44854d2">Metaclass API</h3>
<div class="org-src-container">

<pre><code class="python" >Metaclass.__prepare__(mcls, name, bases, attrs)  # classmethod
Metaclass.__new__(mcls, name, bases, attrs, **kwargs)
Metaclass.__init__(cls, name, bases, attrs, **kwargs)
Metaclass.__call__(cls, *args, **kwargs)
</code></pre>
</div>


</section>
<section id="slide-orgbaca652">
<h3 id="orgbaca652"><code>__prepare__</code></h3>
<ul>
<li>returns dict-like object (empty or not)</li>
<li>if not dict, must be converted to dict before <code>__new__</code> returns</li>

</ul>

</section>
<section >

<div class="org-src-container">

<pre><code class="python" >class OnlyUppercase(dict):
    def __setitem__(self, key, value):
        if isinstance(key, str) and key.isupper():
            super().__setitem__(key, value)

class MyMeta(type):
    @classmethod
    def __prepare__(mcls, name, bases):
        return OnlyUppercase()

    def __new__(mcls, name, bases, attrs):
        return super().__new__(mcls, name, bases, dict(attrs))

class MyClass(metaclass=MyMeta):
    a = 1
    B = 2

MyClass.__dict__  # {..., 'B': 2} (no a)
</code></pre>
</div>


</section>
<section id="slide-orgc13fa0f">
<h3 id="orgc13fa0f"><code>__new__</code></h3>
<ul>
<li><b>class</b> constructor (<code>class MyClass ...</code> -&gt; <code>__new__</code> runs)</li>
<li>most useful</li>

</ul>


</section>
<section id="slide-orgcf38c4f">
<h3 id="orgcf38c4f"><code>__init__</code></h3>
<ul>
<li><b>class</b> initializer (after <code>__new__</code>)</li>
<li>not generally useful</li>

</ul>


</section>
<section id="slide-orgbb6159b">
<h3 id="orgbb6159b"><code>__call__</code></h3>
<ul>
<li><b>object</b> instantiation (before <code>Class.__init__</code>)</li>

</ul>

<div class="org-src-container">

<pre><code class="python" >class MyMeta(type):
    def __call__(cls, *args, **kwargs):
        print('In metaclass', args, kwargs)
        return super().__call__(*args, **kwargs)

class MyClass(metaclass=MyMeta):
    def __init__(cls, *args, **kwargs):
        print('In class', args, kwargs)
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="python" >>>> obj = MyClass(1, 2, foo=42)
In metaclass (1, 2), {'foo': 42}
In class (1, 2) {'foo': 42}
</code></pre>
</div>


</section>
<section id="slide-org4302e5d">
<h3 id="org4302e5d">Call order</h3>
<div class="org-src-container">

<pre><code class="python" >class MyMeta(type):
    @classmethod
    def __prepare__(mcls, name, bases):
        print('Meta __prepare__')
        return super().__prepare__(mcls, name, bases)

    def __new__(mcls, name, bases, attrs):
        print('Meta __new__')
        return super().__new__(mcls, name, bases, attrs)

    def __init__(cls, name, bases, attrs):
        print('Meta __init__')
        return super().__init__(name, bases, attrs)

    def __call__(cls, *args, **kwargs):
        print('Meta __call__')
        return super().__call__(*args, **kwargs)
</code></pre>
</div>

</section>
<section >

<div class="org-src-container">

<pre><code class="python" >class MyClass(metaclass=MyMeta):
    def __new__(cls, *args, **kwargs):
        print('Class __new__')
        return super().__new__(cls)

    def __init__(self, *args, **kwargs):
        print('Class __init__')
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="python" >>>> obj = MyClass()
Meta __prepare__
Meta __new__
Meta __init__
Meta __call__
Class __new__
Class __init__
</code></pre>
</div>


</section>
<section id="slide-org711c390">
<h3 id="org711c390">Example: singleton</h3>
<div class="org-src-container">

<pre><code class="python" >class SingletonMeta(type):

    def __call__(cls, *args, **kwargs):
        if not hasattr(cls, '_inst'):
            obj = super(SingletonMeta, cls).__call__(*args, **kwargs)
            cls._inst = obj
        return cls._inst

class MyClass(metaclass=SingletonMeta):
    pass
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="python" >>>> a = MyClass()
>>> b = MyClass()
>>> a is b
True
</code></pre>
</div>


</section>
<section id="slide-org8782319">
<h3 id="org8782319">Example: metaclass is a callable</h3>
<div class="org-src-container">

<pre><code class="python" >>>> class MyClass(metaclass=print):
...     pass
...
MyClass () {'__qualname__': 'MyClass', '__module__': '__main__'}
>>> MyClass is None
True
</code></pre>
</div>


</section>
</section>
<section>
<section id="slide-org3534c09">
<h2 id="org3534c09">Descriptors</h2>
<ul>
<li>only defined in class-level (not in <code>__init__</code> etc.)</li>
<li>objects with <code>__get__</code>, <code>__set__</code> &amp; <code>__delete__</code> methods</li>
<li><code>__get__</code> &amp; <code>__set__</code> = data descriptors</li>
<li>only <code>__get__</code> = non-data descriptors</li>

</ul>


</section>
<section id="slide-orgbdee7da">
<h3 id="orgbdee7da">Descriptor API</h3>
<div class="org-src-container">

<pre><code class="python" >descr.__get__(self, obj, type=None)  # -> value
descr.__set__(self, obj, value)  # -> None
descr.__delete__(self, obj)  # -> None
</code></pre>
</div>


</section>
<section id="slide-orgec0c45b">
<h3 id="orgec0c45b">Example</h3>
<div class="org-src-container">

<pre><code class="python" >class Descriptor(object):
    def __init__(self, initval=None, name='var'):
        self.val = initval
        self.name = name

    def __get__(self, obj, cls):
        print('get', self.name)
        return self.val

    def __set__(self, obj, val):
        print('set', self.name)
        self.val = val

class MyClass(object):
    attr = Descriptor(initval=10, name='attr')
</code></pre>
</div>

</section>
<section >

<div class="org-src-container">

<pre><code class="python" >>>> MyClass.attr
get attr
10
>>> MyClass.attr = 11
>>> MyClass.attr
11
>>> # oops
</code></pre>
</div>

</section>
<section >

<div class="org-src-container">

<pre><code class="ipython" >>>> a = MyClass()
>>> a.attr
get attr
10
>>> a.attr = 11
set attr
>>> a.attr
get attr
11

>>> b = MyClass()
>>> b.attr
get attr
11
>>> # wat
</code></pre>
</div>


</section>
<section id="slide-org968dda8">
<h3 id="org968dda8">Example</h3>
<ul>
<li>use descriptors to indirectly set values on <code>instance.__dict__</code></li>
<li>if called from class, just return the descriptor class</li>

</ul>

</section>
<section >

<div class="org-src-container">

<pre><code class="python" >class Descriptor(object):
    def __init__(self, name):
        self.name = name

    def __get__(self, obj, cls):
        if obj is None:
            return self
        try:
            print('get', self.name)
            return obj.__dict__[self.name]
        except KeyError:
            raise AttributeError()

    def __set__(self, obj, val):
        print('set', self.name)
        obj.__dict__[self.name] = val

class MyClass(object):
    attr  = Descriptor('attr')
</code></pre>
</div>

</section>
<section >

<div class="org-src-container">

<pre><code class="ipython" >>>> MyClass.attr
<__main__.Descriptor at 0x312....>
>>>
>>> a = MyClass()
>>> a.attr
get attr
Traceback (most recent call last)
....
AttributeError: ...
>>> a.attr = 1
set attr
>>> a.attr
get attr
1
>>>
>>> b = MyClass()
>>> b.attr = 2
set attr
>>> b.attr
get attr
2
>>> a.attr
get attr
1
</code></pre>
</div>


</section>
</section>
<section>
<section id="slide-org9d25576">
<h2 id="org9d25576">Metaclasses &amp; descriptors</h2>
<ul>
<li>attr = Descriptor('attr') -&gt; attr = Descriptor()</li>

</ul>

</section>
<section id="slide-orgd36cff8">
<h3 id="orgd36cff8">Example</h3>
<div class="org-src-container">

<pre><code class="python" >class Descriptor(object):
    def __init__(self):
        self.name = None

    def __get__(self, obj, cls):
        if obj is None:
            return self
        try:
            print('get', self.name)
            return obj.__dict__[self.name]
        except KeyError:
            raise AttributeError()

    def __set__(self, obj, val):
        print('set', self.name)
        obj.__dict__[self.name] = val
</code></pre>
</div>

</section>
<section >

<div class="org-src-container">

<pre><code class="python" >class MyMeta(type):
    def __new__(mcls, name, bases, attrs):
        for k, v in attrs.items():
            if isinstance(v, Descriptor):
                v.name = k
        return super().__new__(mcls, name, bases, attrs)

class MyClass(metaclass=MyMeta):
    attr  = Descriptor()
</code></pre>
</div>

</section>
<section >

<div class="org-src-container">

<pre><code class="ipython" >>>> MyClass.attr
<__main__.Descriptor at 0x312....>
>>>
>>> a = MyClass()
>>> a.attr = 1
set attr
>>> a.attr
get attr
1
>>> a.__dict__
{'attr': 1}
</code></pre>
</div>


</section>
</section>
<section>
<section id="slide-org2ccebf2">
<h2 id="org2ccebf2">Attribute lookup</h2>
<div class="outline-text-2" id="text-org2ccebf2">
</div></section>
<section id="slide-org3cbd164">
<h3 id="org3cbd164">Object-level (instance.attr)</h3>
<ul>
<li class="fragment appear">attr in <code>Class.__dict__</code> and attr is data descriptor -&gt; <code>Class.__dict__['attr'].__get__(instance, Class)</code></li>
<li class="fragment appear">attr in <code>instance.__dict__</code> -&gt; <code>instance.__dict__['attr']</code></li>
<li class="fragment appear">attr in <code>Class.__dict__</code> <b>and</b> attr is <b>not</b> a descriptor -&gt; <code>Class.__dict__['attr'].__get__(instance, Class)</code></li>
<li class="fragment appear">attr in <code>Class.__dict__</code> -&gt; <code>Class.__dict__['attr']</code></li>
<li class="fragment appear"><code>Class.__getattr__</code> exists -&gt; <code>Class.__getattr__('attr')</code></li>

</ul>


</section>
<section id="slide-org6360737">
<h3 id="org6360737">Class-level (Class.attr)</h3>
<ul>
<li class="fragment appear">attr in <code>Metaclass.__dict__</code> and attr is data desciptor -&gt; <code>Metaclass.__dict__['attr'].__get__(Class, Metaclass)</code></li>
<li class="fragment appear">attr in <code>Class.__dict__</code> and attr is descriptor -&gt; <code>Class.__dict__['attr'].__get__(None, Class)</code></li>
<li class="fragment appear">attr in <code>Class.__dict__</code> -&gt; <code>Class.__dict__['attr']</code></li>

</ul>


</section>
<section id="slide-orgfc3f40a">
<h3 id="orgfc3f40a">Class-level (cont.)</h3>
<ul>
<li class="fragment appear">attr in <code>Metaclass.__dict__</code> <b>and</b> attr is <b>not</b> a descriptor -&gt; <code>Metaclass.__dict__['attr'].__get__(Class, Metaclass)</code></li>
<li class="fragment appear">attr in <code>Metaclass.__dict__</code> -&gt; <code>Metaclass.__dict__['attr']</code></li>
<li class="fragment appear"><code>Metaclass.__getattr__</code> exists -&gt; <code>Metaclass.__getattr__('attr')</code></li>

</ul>


</section>
</section>
<section>
<section id="slide-org05e621a">
<h2 id="org05e621a">Links</h2>
<ul>
<li><a href="https://blog.ionelmc.ro/2015/02/09/understanding-python-metaclasses/">Understanding Python metaclasses</a></li>
<li><a href="https://docs.python.org/3/howto/descriptor.html">Descriptor HowTo Guide</a></li>
<li><a href="https://www.youtube.com/watch?v=sPiWg5jSoZI">Dave Beazley: Python 3 Metaprogramming</a></li>
<li><a href="https://www.python.org/dev/peps/pep-3115/">PEP 3115: Metaclasses in Python 3</a></li>
<li><a href="https://github.com/alexpeits/metaclasses-pythonmeetup-hsgr">Presentation git repo</a></li>

</ul>
</section>
</section>
</div>
</div>
<script src="./static/reveal.js/lib/js/head.min.js"></script>
<script src="./static/reveal.js/js/reveal.js"></script>

<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: true,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
overview: true,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'none', // default/cube/page/concave/zoom/linear/fade/none
transitionSpeed: 'default',
multiplex: {
    secret: '', // null if client
    id: '', // id, obtained from socket.io server
    url: '' // Location of socket.io server
},

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: './static/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
 { src: './static/reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
 { src: './static/reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: './static/reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: './static/reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
 { src: './static/reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]
});
</script>
</body>
</html>
